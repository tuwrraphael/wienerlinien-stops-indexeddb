const t=Math.PI/2,e=-t,n=Math.PI,o=-n,s=2*Math.PI,r=t=>t*(Math.PI/180),i=t=>t/(Math.PI/180);const a="https://www.data.wien.gv.at/txt/wrlinien-gtfs-stops.txt",l=6048e5;class c{constructor(t){this.dbName=t}async import(t){const e=(await fetch(a)).body.pipeThrough(new TextDecoderStream);await function(t,e){return new Promise((n,o)=>{let s="",r=!1,i={stop_id:0,stop_name:0,stop_lat:0,stop_lon:0},a=Object.keys(i).length;const l=new WritableStream({write(t){let n=[],o=!1,l=(s+=t).replace(/\r/g,"").split("\n");l.map(t=>{let e=Array.from(function*(t,e){let n=t.split(e),o="";for(let t of n)'"'==(t=o+t)[0]?'"'==t[t.length-1]&&(t.length<=2||'"'!=t[t.length-2])?(yield t.substring(1,t.length-1),o=""):o+=t:(yield t,o="");o.length&&(yield o)}(t,","));if(!r||s.length<2){for(let t in i)i.hasOwnProperty(t)&&(i[t]=e.indexOf(t));r=!0}r&&e.length>=a?n.push({stop_id:e[i.stop_id],stop_name:e[i.stop_name],stop_lat:parseFloat(e[i.stop_lat]),stop_lon:parseFloat(e[i.stop_lon])}):o=!0}),s=o?l[l.length-1]:"",n.length&&e(n)},close:function(){n()},abort:function(){o()}});t.pipeTo(l)})}(e,t)}query(a,l,c){const[p,u,h,d]=function(a,l,c){a=r(a),l=r(l);let p,u,h,d=c/6371.01,g=a-d,f=a+d;return g>e&&f<t?((p=l-(h=Math.asin(Math.sin(d)/Math.cos(a))))<o&&(p+=s),(u=l+h)>n&&(u-=s)):(g=Math.max(g,e),f=Math.min(f,t),p=o,u=n),[i(g),i(p),i(f),i(u)]}(a,l,c/1e3);return new Promise((t,e)=>{let n=IDBKeyRange.bound(p,h),o=IDBKeyRange.bound(u,d);this.openDb().then(s=>{let r=s.transaction("Stops").objectStore("Stops"),i=[],a=[],l=r.index("stop_lat").getAllKeys(n),c=r.index("stop_lon").getAllKeys(o);function p(){let n=s.transaction("Stops").objectStore("Stops"),o=[];a.forEach(s=>{let r=n.get(s);r.onsuccess=()=>{o.push(r.result),o.length==a.length&&t(o)},r.onerror=t=>e(t)})}l.onsuccess=()=>{i.length&&(a=l.result.filter(t=>i.indexOf(t)>-1),p()),i=l.result},l.onerror=t=>e(t),c.onsuccess=()=>{i.length&&(a=c.result.filter(t=>i.indexOf(t)>-1),p()),i=c.result},c.onerror=t=>e(t)},t=>e(t))})}openDb(){let t=this;return new Promise((e,n)=>{let o=window.indexedDB.open(t.dbName,2);o.onsuccess=function(){e(o.result)},o.onupgradeneeded=function(t){if(t.oldVersion<2){let t=o.result.createObjectStore("Stops",{keyPath:"stop_id"});t.createIndex("stop_lat","stop_lat",{unique:!1}),t.createIndex("stop_lon","stop_lon",{unique:!1}),t.createIndex("version",["version"],{unique:!1}),o.result.createObjectStore("Logs",{keyPath:"id"})}},o.onerror=function(t){n(t)}})}getLogEntry(){return new Promise((t,e)=>{this.openDb().then(n=>{let o=n.transaction("Logs").objectStore("Logs").get(0);o.onsuccess=()=>t(o.result||{version:0,updated:0}),o.onerror=t=>e(t)},t=>e(t))})}async maintainDb(){let t=await this.openDb(),e=await this.getLogEntry();if(+new Date-e.updated<l)return;e.version++,await this.import((function(n){let o=t.transaction("Stops","readwrite").objectStore("Stops");for(let t of n)o.put(Object.assign(Object.assign({},t),{version:e.version}))}));let n=t.transaction("Stops","readwrite"),o=n.objectStore("Stops");var s=o.index("version").openKeyCursor(IDBKeyRange.only(e.version-1));s.onsuccess=function(){var t=s.result;t&&(o.delete(t.primaryKey),t.continue)},(n=t.transaction("Logs","readwrite")).objectStore("Logs").put({id:0,updated:+new Date,version:e.version})}}export{c as StopStore};
//# sourceMappingURL=index.js.map
